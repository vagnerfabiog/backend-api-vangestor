// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String?  @unique
  phone     String?  @unique
  password  String?
  role      Role     @default(DRIVER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  vehiclesOwned    Vehicle[]       @relation("VehicleOwner")
  driverVehicles   DriverVehicle[]
  students         Student[]       @relation("DriverStudents")
  responsibleLinks Responsible[]
  routesDriven     Route[]         @relation("DriverRoutes")
}

model Vehicle {
  id        String   @id @default(uuid())
  plate     String   @unique
  model     String
  capacity  Int?
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  ownerId  String
  owner    User            @relation("VehicleOwner", fields: [ownerId], references: [id])
  drivers  DriverVehicle[]
  students Student[]
  routes   Route[]         @relation("VehicleRoutes")
}

model DriverVehicle {
  id        String @id @default(uuid())
  driverId  String
  vehicleId String

  driver  User    @relation(fields: [driverId], references: [id])
  vehicle Vehicle @relation(fields: [vehicleId], references: [id])

  @@unique([driverId, vehicleId])
}

model Student {
  id             String    @id @default(uuid())
  name           String
  birthDate      DateTime?
  grade          String?
  school         String
  address        String?
  neighborhood   String?
  city           String?
  zipCode        String?
  route          String?
  shift          String?
  monthlyFee     Decimal?  @db.Decimal(10, 2)
  paymentDay     Int?
  paymentMethod  String?
  contractStart  DateTime?
  contractEnd    DateTime?
  financialNotes String?
  generalNotes   String?
  active         Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relações
  driverId  String?
  vehicleId String?

  driver  User?    @relation("DriverStudents", fields: [driverId], references: [id])
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])

  responsibles Responsible[]
  Stop         Stop[]
}

model Responsible {
  id        String   @id @default(uuid())
  name      String
  phone     String
  email     String?
  relation  String?
  invited   Boolean  @default(false) // true após o envio do link
  accepted  Boolean  @default(false) // true após criar senha e login
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  studentId String
  student   Student @relation(fields: [studentId], references: [id])

  // vinculação opcional ao usuário (quando ele ativa a conta)
  userId String?
  user   User?   @relation(fields: [userId], references: [id])
}

enum Role {
  ADMIN // dono / gestor da frota
  DRIVER // motorista
  RESPONSIBLE // pai/mãe/responsável com acesso no app dos pais
}

model Route {
  id          String  @id @default(uuid())
  name        String
  period      String // Manhã / Tarde / Noite
  startTime   String // "07:00"
  description String?
  active      Boolean @default(true)

  status    RouteStatus @default(PENDING)
  startedAt DateTime?
  endedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driverId  String?
  vehicleId String?

  driver  User?    @relation("DriverRoutes", fields: [driverId], references: [id])
  vehicle Vehicle? @relation("VehicleRoutes", fields: [vehicleId], references: [id])
  stops   Stop[]
}

model Stop {
  id      String  @id @default(uuid())
  type    String // "STUDENT" | "FREE" (UI decide)
  name    String?
  address String?
  radius  Int?
  order   Int? // ordem na rota

  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  status      StopStatus @default(PENDING)
  arrivedAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  routeId String
  route   Route  @relation(fields: [routeId], references: [id])

  studentId String?
  student   Student? @relation(fields: [studentId], references: [id])
}

enum RouteStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum StopStatus {
  PENDING
  ARRIVED
  COMPLETED
  SKIPPED
}
